---
layout: post
category: 云计算
tags: docker
description: 本文主要分析docker容器跨主机连接实现方式，参考自官方文档。
---

### 问题
  1. 主机1上启动一个运行redis-server的docker容器
  2. 从主机2上运行redis-cli的docker容器访问主机1上docker容器中的redis-server
  
### 官方方案

	(consumer) --> (redis-ambassador) ---network---> (redis-ambassador) --> (redis)

### redis-ambassador

其中运行socat进行数据转发。

### 服务端

#### redis-server

~~~
	
paas@ubuntu:~$ docker run -d --name redis shipyard/redis
ee76fff375499f5f69060633e3c07edcf92d264d41b6e71ad4123891bb9808ba
paas@ubuntu:~$ docker inspect 5ea7e8765ad4f94e97514abadf730a682a16fe6ed4ef221ea0b659e2381b256b
paas@ubuntu:~$ docker inspect ee76fff375499f5f69060633e3c07edcf92d264d41b6e71ad4123891bb9808ba
[{
    "ID": "ee76fff375499f5f69060633e3c07edcf92d264d41b6e71ad4123891bb9808ba",
    "Created": "2014-05-08T03:15:28.374074044Z",
    "Path": "/usr/local/bin/redis-server",
    "Args": [
        "/etc/redis.conf"
    ],
    "Config": {
        "Hostname": "ee76fff37549",
        "Domainname": "",
        "User": "",
        "Memory": 0,
        "MemorySwap": 0,
        "CpuShares": 0,
        "AttachStdin": false,
        "AttachStdout": false,
        "AttachStderr": false,
        "PortSpecs": null,
        "ExposedPorts": {
            "6379/tcp": {}
        },
        "Tty": false,
        "OpenStdin": false,
        "StdinOnce": false,
        "Env": [
            "HOME=/",
            "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        ],
        "Cmd": [
            "/etc/redis.conf"
        ],
        "Image": "shipyard/redis",
        "Volumes": {
            "/var/lib/redis": {}
        },
        "WorkingDir": "",
        "Entrypoint": [
            "/usr/local/bin/redis-server"
        ],
        "NetworkDisabled": false,
        "OnBuild": null
    },
    "State": {
        "Running": true,
        "Pid": 3244,
        "ExitCode": 0,
        "StartedAt": "2014-05-08T03:16:16.392818522Z",
        "FinishedAt": "2014-05-08T03:15:42.985608485Z",
        "Ghost": false
    },
    "Image": "b48b681ac98459fdc7efc98c9cce7e25f8b1537a4496aad9d355b3b11ca7144a",
    "NetworkSettings": {
        "IPAddress": "172.17.0.2",
        "IPPrefixLen": 16,
        "Gateway": "172.17.42.1",
        "Bridge": "docker0",
        "PortMapping": null,
        "Ports": {
            "6379/tcp": null
        }
    },
    "ResolvConfPath": "/var/lib/docker/containers/ee76fff375499f5f69060633e3c07edcf92d264d41b6e71ad4123891bb9808ba/resolv.conf",
    "HostnamePath": "/var/lib/docker/containers/ee76fff375499f5f69060633e3c07edcf92d264d41b6e71ad4123891bb9808ba/hostname",
    "HostsPath": "/var/lib/docker/containers/ee76fff375499f5f69060633e3c07edcf92d264d41b6e71ad4123891bb9808ba/hosts",
    "Name": "/redis",
    "Driver": "aufs",
    "ExecDriver": "native-0.1",
    "Volumes": {
        "/var/lib/redis": "/var/lib/docker/vfs/dir/f8a140fcfba06f9fc454d30a11a23c0ed981b712a8b29f913fdbbd4f2d5a9653"
    },
    "VolumesRW": {
        "/var/lib/redis": true
    },
    "HostConfig": {
        "Binds": null,
        "ContainerIDFile": "",
        "LxcConf": [],
        "Privileged": false,
        "PortBindings": {
            "6379/tcp": null
        },
        "Links": null,
        "PublishAllPorts": false,
        "Dns": null,
        "DnsSearch": null,
        "VolumesFrom": null
    }
}]

~~~

##### iptables

~~~

paas@ubuntu:~$ sudo iptables -S
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT
paas@ubuntu:~$ sudo iptables -S -t nat
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
-N DOCKER
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s 172.17.0.0/16 ! -d 172.17.0.0/16 -j MASQUERADE

~~~

##### 说明


#### svendowideit/ambassador

~~~

paas@ubuntu:~$docker run -d --link redis:redis --name redis_ambassador -p 6379:6379 svendowideit/ambassador
4480d8897fdedc1f34f0460d3853e4cc696a3751891f5783ebc12c44d985e68e
paas@ubuntu:~$ docker inspect 4480d8897fdedc1f34f0460d3853e4cc696a3751891f5783ebc12c44d985e68e
[{
    "ID": "4480d8897fdedc1f34f0460d3853e4cc696a3751891f5783ebc12c44d985e68e",
    "Created": "2014-05-08T03:19:28.369725238Z",
    "Path": "/bin/sh",
    "Args": [
        "-c",
        "env | grep _TCP= | sed 's/.*_PORT_\\([0-9]*\\)_TCP=tcp:\\/\\/\\(.*\\):\\(.*\\)/socat TCP4-LISTEN:\\1,fork,reuseaddr TCP4:\\2:\\3 \\\u0026/'  | sh \u0026\u0026 top"
    ],
    "Config": {
        "Hostname": "4480d8897fde",
        "Domainname": "",
        "User": "",
        "Memory": 0,
        "MemorySwap": 0,
        "CpuShares": 0,
        "AttachStdin": false,
        "AttachStdout": false,
        "AttachStderr": false,
        "PortSpecs": null,
        "ExposedPorts": {
            "6379/tcp": {}
        },
        "Tty": false,
        "OpenStdin": false,
        "StdinOnce": false,
        "Env": [
            "HOME=/",
            "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        ],
        "Cmd": [
            "/bin/sh",
            "-c",
            "env | grep _TCP= | sed 's/.*_PORT_\\([0-9]*\\)_TCP=tcp:\\/\\/\\(.*\\):\\(.*\\)/socat TCP4-LISTEN:\\1,fork,reuseaddr TCP4:\\2:\\3 \\\u0026/'  | sh \u0026\u0026 top"
        ],
        "Image": "svendowideit/ambassador",
        "Volumes": null,
        "WorkingDir": "",
        "Entrypoint": null,
        "NetworkDisabled": false,
        "OnBuild": null
    },
    "State": {
        "Running": true,
        "Pid": 3316,
        "ExitCode": 0,
        "StartedAt": "2014-05-08T03:19:28.466496993Z",
        "FinishedAt": "0001-01-01T00:00:00Z",
        "Ghost": false
    },
    "Image": "0d2200edc53e6e8a201d7d42ddcac3235bfb8655223ba1029d3e7765736f2a75",
    "NetworkSettings": {
        "IPAddress": "172.17.0.3",
        "IPPrefixLen": 16,
        "Gateway": "172.17.42.1",
        "Bridge": "docker0",
        "PortMapping": null,
        "Ports": {
            "6379/tcp": [
                {
                    "HostIp": "0.0.0.0",
                    "HostPort": "6379"
                }
            ]
        }
    },
    "ResolvConfPath": "/var/lib/docker/containers/4480d8897fdedc1f34f0460d3853e4cc696a3751891f5783ebc12c44d985e68e/resolv.conf",
    "HostnamePath": "/var/lib/docker/containers/4480d8897fdedc1f34f0460d3853e4cc696a3751891f5783ebc12c44d985e68e/hostname",
    "HostsPath": "/var/lib/docker/containers/4480d8897fdedc1f34f0460d3853e4cc696a3751891f5783ebc12c44d985e68e/hosts",
    "Name": "/redis_ambassador",
    "Driver": "aufs",
    "ExecDriver": "native-0.1",
    "Volumes": {},
    "VolumesRW": {},
    "HostConfig": {
        "Binds": null,
        "ContainerIDFile": "",
        "LxcConf": [],
        "Privileged": false,
        "PortBindings": {
            "6379/tcp": [
                {
                    "HostIp": "0.0.0.0",
                    "HostPort": "6379"
                }
            ]
        },
        "Links": null,
        "PublishAllPorts": false,
        "Dns": null,
        "DnsSearch": null,
        "VolumesFrom": null
    }
}]

~~~

##### iptables

~~~

paas@ubuntu:~$ sudo iptables -S
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
-A FORWARD -s 172.17.0.2/32 -d 172.17.0.3/32 -i docker0 -o docker0 -p tcp -m tcp --sport 6379 -j ACCEPT
-A FORWARD -s 172.17.0.3/32 -d 172.17.0.2/32 -i docker0 -o docker0 -p tcp -m tcp --dport 6379 -j ACCEPT
-A FORWARD -d 172.17.0.3/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 6379 -j ACCEPT
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT

paas@ubuntu:~$ sudo iptables -S -t nat
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
-N DOCKER
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s 172.17.0.0/16 ! -d 172.17.0.0/16 -j MASQUERADE
-A DOCKER -p tcp -m tcp --dport 6379 -j DNAT --to-destination 172.17.0.3:6379

~~~

##### 说明


### 客户端